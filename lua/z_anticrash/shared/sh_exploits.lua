-- [[ CREATED BY ZOMBIE EXTINGUISHER ]]

/*
	Measures against various exploits
*/

/*
	Name: Chatclear exploit 
	Used by: Angry script kiddies that got banned from their fav DarkRP server
*/

if SH_ANTICRASH.SETTINGS.EXPLOITS.CHATCLEAR then

	local kickMsg = [[
===================================	
KICKED!

By: Anti-Crash

Reason: ChatClear exploit!

===================================	]]

	local function IsOffender(str)
		
		local filteredStr = string.gsub(str, "[%c%s]", '')
		
		return #filteredStr == 0
		
	end

	if CLIENT then

		local function ChatFilter(ply, str, isTeam, isDead)
		
			if IsOffender(str) then 
				return true 
			end
		
		end
		hook.Add("OnPlayerChat","z_anticrash_ChatFilter",ChatFilter)

	end

	if SERVER then

		local offenders = {}

		local function ChatFilter(ply, str, isTeam)

			if IsOffender(str) then
				
				offenders[ply] = (offenders[ply] or 0) + 1
				
				if SH_ANTICRASH.SETTINGS.EXPLOITS.CHATCLEARKICK and offenders[ply] > SH_ANTICRASH.SETTINGS.EXPLOITS.CHATCLEARKICKAMOUNT then
					ply:Kick(kickMsg)
					
					local plyFormat = SH_ANTICRASH.UTILS.LOG.GetPlayerFormat(ply)
					SH_ANTICRASH.UTILS.LOG.Print("##chatClearKick %"..plyFormat)
				end
				
				return true
				
			end
		
		end
		hook.Add("PlayerSay","z_anticrash_ChatFilter",ChatFilter)

	end
	
end

/*
	Name: Blackscreen exploit + Fading Door post processing exploit
	Used by: Roblox kiddies that wanna ruin the fun for everyone
	Reference: Thanks to SnowboiTheGr8 for patching this exploit in his crident anticrash
	Link: https://github.com/SnowboiTheGr8/gmod-anticrash/blob/master/lua/autorun/server/sv_crident-anticrash.lua
*/

if SERVER then

	local function IsBlackoutMaterial(mat)
		return string.StartWith(mat, "pp/") and string.EndsWith(mat, "/copy")
	end

	local function BlockBlackoutProps(ply, model, ent)
		
		local mat = ent:GetMaterial()
		
		if IsBlackoutMaterial(mat) then
			ent:Remove()
		end
	
	end
	hook.Add("PlayerSpawnedProp", "z_anticrash_BlockBlackoutProps", BlockBlackoutProps)

	local function BlockBlackoutMaterial(ply, tr, tool)
	
		local toolName = tool:lower()
	
		if toolName == "material" then
		
			local tool = ply:GetActiveWeapon():GetToolObject()
			local mat = string.lower(tool:GetClientInfo("override"))
			
			if IsBlackoutMaterial(mat) then
				return false
			end
			
		end
		
		if toolName == "fading_door" then
		
			local tool = ply:GetActiveWeapon():GetToolObject()
			local mat = string.lower(tool:GetClientInfo("mat"))

			if IsBlackoutMaterial(mat) then
				return false
			end
		
		end

	end
	hook.Add( "CanTool", "z_anticrash_BlockBlackoutMaterial", BlockBlackoutMaterial)

end

/*
	Name: ModelScale exploit
	Used by: Frustrated virgin nerds
	Reference: Thanks to Reism for patching this in his workshop mod
	Link: https://steamcommunity.com/sharedfiles/filedetails/?id=1535483797
*/

if SERVER then

	local function PatchModelScaleExploit(ply, tr, tool)

		local dupeTbl

		if tool == "adv_duplicator" then
			dupeTbl = ply:GetActiveWeapon():GetToolObject().Entities
			
		elseif tool == "advdupe2" and ply.AdvDupe2 then
			 dupeTbl = ply.AdvDupe2.Entities
			 
		elseif tool == "duplicator" and ply.CurrentDupe then
			dupeTbl = ply.CurrentDupe.Entities
			
		end

		if !dupeTbl then return end
		
		for k, dupeElement in pairs(dupeTbl) do
			
			if !dupeElement.ModelScale then 
				continue 
			end
			
			if dupeElement.ModelScale > 10 or dupeElement.ModelScale < 0.1 then
				dupeElement.ModelScale = 1
			end
			
		end

	end
	hook.Add( "CanTool", "z_anticrash_PatchModelScaleExploit", PatchModelScaleExploit)

end

/*
	Name: SetAngles/SetPos exploits
	Used by: Little kiddos who wanna be cool
	Reference: Special thanks to the kiddos who spammed this method on my server
*/

local ent = FindMetaTable("Entity")
ent.__oldSetAngles = ent.__oldSetAngles or ent.SetAngles
ent.__oldSetPos = ent.__oldSetPos or ent.SetPos

local phys = FindMetaTable("PhysObj")
phys.__oldSetAngles = phys.__oldSetAngles or phys.SetAngles
phys.__oldSetPos = phys.__oldSetPos or phys.SetPos

function ent:SetAngles(oldAngles)

	angles = oldAngles or Angle()
	angles.p = oldAngles.p or 0
	angles.y = oldAngles.y or 0
	angles.r = oldAngles.r or 0
	
	self:__oldSetAngles(angles)

end

function ent:SetPos(oldPos)

	pos = oldPos or Vector()
	pos.x = oldPos.x or 0
	pos.y = oldPos.y or 0
	pos.z = oldPos.z or 0
	
	self:__oldSetPos(pos)

end

function phys:SetAngles(oldAngles)

	angles = oldAngles or Angle()
	angles.p = oldAngles.p or 0
	angles.y = oldAngles.y or 0
	angles.r = oldAngles.r or 0
	
	self:__oldSetAngles(angles)

end

function phys:SetPos(oldPos)

	pos = oldPos or Vector()
	pos.x = oldPos.x or 0
	pos.y = oldPos.y or 0
	pos.z = oldPos.z or 0
	
	self:__oldSetPos(pos)

end

/*
	Name: ApplyForce (slider) exploit
	Used by: E2 kiddos
	Reference: Thanks to CaptainPRICE (https://github.com/wiremod/wire/issues/1189) for finding the magic number
*/

local phys = FindMetaTable("PhysObj")
phys.__oldApplyForceCenter = phys.__oldApplyForceCenter or phys.ApplyForceCenter
phys.__oldApplyForceOffset = phys.__oldApplyForceOffset or phys.ApplyForceOffset

function phys:ApplyForceCenter(force)
	
	force = force or Vector()
	force.x = math.Clamp(force.x, -1e38, 1e38)
	force.y = math.Clamp(force.y, -1e38, 1e38)
	force.z = math.Clamp(force.z, -1e38, 1e38)
	
	self:__oldApplyForceCenter(force)

end

function phys:ApplyForceOffset(force, pos)

	force = force or Vector()
	force.x = math.Clamp(force.x, -1e38, 1e38)
	force.y = math.Clamp(force.y, -1e38, 1e38)
	force.z = math.Clamp(force.z, -1e38, 1e38)
	
	self:__oldApplyForceOffset(force, pos)

end

/*
	Name: DataTable console spam (not an exploit)
	-> DataTable warning: (class prop_vehicle_airboat): Out-of-range value (-0.140234) in SendPropFloat 'm_flCycle', clamping.
	-> DataTable warning: prop_physics: Out-of-range value (50.000000) in SendPropFloat 'm_flSpread', clamping.
*/

local ent = FindMetaTable("Entity")
ent.__oldSetCycle = ent.__oldSetCycle or ent.SetCycle

function ent:SetCycle(val)

	val = math.Clamp(val or 0, 0, 1)
	
	self:__oldSetCycle(val)

end

/*
	Name: Model Manipulator Flex exploit
	-> Will block everyone's screen by messing up the model meshes
*/

local ent = FindMetaTable("Entity")

// No need to keep old, disable completely
function ent:SetFlexScale() end
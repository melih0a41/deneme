--[[
    AI Anti-Exploit System
    Initialization File
]]

if SERVER then
    -- Create global table with defaults
    AntiExploit = AntiExploit or {}
    AntiExploit.Version = "Autonomous Ultimate 3.0"
    AntiExploit.StartTime = SysTime()
    
    -- Initialize critical tables early
    AntiExploit.ThreatDatabase = {
        known_exploits = {},
        workshop_threats = {},
        network_signatures = {},
        behavioral_patterns = {},
        confidence_matrix = {},
        malicious_domains = {},
        custom_signatures = {}
    }
    
    -- Load configuration
    include("antiexploit/sh_config.lua")
    
    -- Core modules
    include("antiexploit/core/sv_database.lua")
    include("antiexploit/core/sv_brain.lua")
    include("antiexploit/core/sv_main.lua")
    
    -- Utility modules
    include("antiexploit/utils/sv_helpers.lua")
    include("antiexploit/utils/sv_logging.lua")
    include("antiexploit/utils/sv_persistence.lua")
    include("antiexploit/utils/sv_error_logger.lua") -- Yeni error logger
    
    -- Protection modules
    include("antiexploit/modules/protection/sv_workshop.lua")
    include("antiexploit/modules/protection/sv_network.lua")
    include("antiexploit/modules/protection/sv_memory.lua")
    include("antiexploit/modules/protection/sv_behavior.lua")
    include("antiexploit/modules/protection/sv_code.lua")
    
    -- Analysis modules
    include("antiexploit/modules/analysis/sv_http.lua")
    include("antiexploit/modules/analysis/sv_code.lua")
    include("antiexploit/modules/analysis/sv_network.lua")
    include("antiexploit/modules/analysis/sv_player.lua")
    
    -- Learning modules
    include("antiexploit/modules/learning/sv_neural.lua")
    include("antiexploit/modules/learning/sv_patterns.lua")
    include("antiexploit/modules/learning/sv_intelligence.lua")
    
    -- Special modules
    include("antiexploit/modules/special/sv_npc_protection.lua")
    include("antiexploit/modules/special/sv_self_healing.lua")
    include("antiexploit/modules/special/sv_zero_day_protection.lua") -- YENİ
    include("antiexploit/modules/special/sv_loki_detection.lua") -- YENİ
    include("antiexploit/modules/special/sv_heuristic_detection.lua") -- YENİ
    include("antiexploit/modules/special/sv_exploit_test.lua") -- YENİ
    
    -- Initialize system with safety check
    hook.Add("Initialize", "AntiExploit_SystemInit", function()
        if AntiExploit and AntiExploit.Initialize then
            AntiExploit:Initialize()
        else
            print("[AntiExploit] ERROR: System failed to initialize properly!")
        end
    end)
    
    -- UI files
    AddCSLuaFile("antiexploit/sh_config.lua")
    AddCSLuaFile("antiexploit/ui/cl_menu.lua")
    AddCSLuaFile("antiexploit/ui/cl_notifications.lua")
end

if CLIENT then
    -- Font sistemini korumaya al
    local protected_functions = {
        ["surface.CreateFont"] = surface.CreateFont,
        ["surface.SetFont"] = surface.SetFont,
        ["surface.GetTextSize"] = surface.GetTextSize,
        ["draw.SimpleText"] = draw.SimpleText,
        ["draw.DrawText"] = draw.DrawText
    }
    
    -- Sadece config yükle
    include("antiexploit/sh_config.lua")
    
    -- UI dosyalarını GEÇ yükle, font sistemine dokunma
    timer.Simple(3, function()
        -- Font sistemi korunmuş olmalı
        if file.Exists("antiexploit/ui/cl_menu.lua", "LUA") then
            include("antiexploit/ui/cl_menu.lua")
        end
        if file.Exists("antiexploit/ui/cl_notifications.lua", "LUA") then
            include("antiexploit/ui/cl_notifications.lua")
        end
        
        -- Korunan fonksiyonları geri yükle
        for name, func in pairs(protected_functions) do
            local parts = string.Explode(".", name)
            if #parts == 2 then
                _G[parts[1]][parts[2]] = func
            end
        end
    end)
end
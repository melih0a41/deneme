--[[
    Core Main Module
    Central system initialization and coordination
]]

function AntiExploit:Initialize()
    -- Initialize all required tables FIRST
    self.ThreatDatabase = self.ThreatDatabase or {
        known_exploits = {},
        workshop_threats = {},
        network_signatures = {},
        behavioral_patterns = {},
        confidence_matrix = {},
        malicious_domains = {},
        custom_signatures = {}
    }
    
    self.PlayerData = self.PlayerData or {}
    self.PlayerAssessments = self.PlayerAssessments or {}
    self.LearnedPatterns = self.LearnedPatterns or {hooks = {}, networks = {}, addons = {}}
    self.LearnedSafeAddons = self.LearnedSafeAddons or {}
    self.timer_count = self.timer_count or {}
    
    -- THEN load previous state if available
    self:LoadSystemState()
    
    -- Initialize all systems
    self:InitializeAutonomousSystem()
    
    -- Auto-save timer
    timer.Create("AntiExploit_AutoSave", AntiExploit.Config.AUTO_SAVE_INTERVAL, 0, function()
        self:SaveSystemState()
    end)
    
    -- Welcome message
    timer.Simple(5, function()
        print("ü§ñ AUTONOMOUS AI READY")
        print("üõ°Ô∏è Zero admin intervention required")
        print("‚ö° Server is now fully protected")
        print("üß† AI learning continuously")
    end)
end

function AntiExploit:InitializeAutonomousSystem()
    print("ü§ñ AUTONOMOUS AI ANTI-EXPLOIT SYSTEM")
    print(string.rep("=", 60))
    print("Version: " .. self.Version)
    print("Mode: FULLY AUTONOMOUS (Zero Admin Required)")
    print("Learning: ACTIVE")
    print("Adaptation: ACTIVE")
    print(string.rep("=", 60))
    
    -- Core systems
    self:InitializeAIBrain()
    self:LoadThreatDatabase()
    self:StartAutonomousLearning()
    self:InitializeAutoOptimization()
    
    -- Auto-protect all systems
    self:DeployComprehensiveProtection()
    
    print("‚úÖ AUTONOMOUS SYSTEM FULLY OPERATIONAL")
    print("‚ö° All protection systems: ACTIVE")
    print("üß† AI Learning: AUTONOMOUS")
    print("üöÄ Auto-optimization: ACTIVE")
    print("üõ°Ô∏è Zero admin intervention required")
    print(string.rep("=", 60))
end

function AntiExploit:DeployComprehensiveProtection()
    -- Workshop Protection
    self:DeployWorkshopShield()
    
    -- Network Protection
    self:DeployNetworkGuard()
    
    -- Memory Protection
    self:DeployMemoryProtection()
    
    -- Behavioral Protection
    self:DeployBehavioralProtection()
    
    -- Code Injection Protection
    self:DeployCodeProtection()
    
    -- Real-time monitoring
    self:StartRealTimeMonitoring()
end

function AntiExploit:StartRealTimeMonitoring()
    -- Real-time player monitoring - SADECE GER√áEK OYUNCULAR
    timer.Create("AntiExploit_PlayerMonitoring", AntiExploit.Config.PLAYER_MONITOR_INTERVAL, 0, function()
        for _, ply in ipairs(player.GetAll()) do
            if IsValid(ply) and ply:IsPlayer() and not ply:IsBot() then
                -- Admin whitelist kontrol√º
                if AntiExploit.Config.WHITELIST_ADMINS and ply:IsAdmin() then
                    continue -- Admin'leri kontrol etme
                end
                
                -- Ekstra NPC kontrol√º
                if not ply:IsNPC() and not ply:IsNextBot() then
                    local class = ply:GetClass()
                    if not (class and string.find(class, "npc")) then
                        self:AnalyzePlayerBehavior(ply)
                    end
                end
            end
        end
    end)
    
    -- System health monitoring
    timer.Create("AntiExploit_SystemHealth", AntiExploit.Config.SYSTEM_HEALTH_INTERVAL, 0, function()
        self:MonitorSystemHealth()
    end)
    
    print("[Monitoring] ‚úÖ Real-time monitoring active")
end

function AntiExploit:MonitorSystemHealth()
    local fps = 1 / engine.TickInterval()
    local memory_usage = collectgarbage("count")
    local player_count = #player.GetAll()
    
    -- Check system performance
    if fps < AntiExploit.Config.MIN_FPS_THRESHOLD then
        print("[System Health] Low FPS detected: " .. math.Round(fps, 1))
        self:ReduceMonitoringLoad()
    end
    
    if memory_usage > AntiExploit.Config.MAX_MEMORY_MB * 1024 then
        print("[System Health] High memory usage: " .. math.Round(memory_usage/1024, 1) .. "MB")
        collectgarbage("collect")
    end
    
    -- Log system status
    if player_count > 0 and AntiExploit.Config.VERBOSE_LOGGING then
        print(string.format("[System Health] FPS: %.1f | Memory: %.1fMB | Players: %d", 
                           fps, memory_usage/1024, player_count))
    end
end

function AntiExploit:ReduceMonitoringLoad()
    if timer.Exists("AntiExploit_PlayerMonitoring") then
        timer.Adjust("AntiExploit_PlayerMonitoring", 2)
        print("[Auto-Tune] Reduced monitoring frequency due to low FPS")
    end
end

-- Mode switching command (opsiyonel)
concommand.Add("antiexploit_mode", function(ply, cmd, args)
    if not ply:IsAdmin() then return end
    
    local mode = args[1] or "current"
    
    if mode == "safe" then
        AntiExploit.Config.AUTO_BAN_THRESHOLD = 1.0
        AntiExploit.Config.AUTO_KICK_THRESHOLD = 0.99
        AntiExploit.Config.AUTO_WARN_THRESHOLD = 0.95
        
        print("[AntiExploit] Switched to SAFE mode - Monitoring only")
        ply:ChatPrint("[AntiExploit] Switched to SAFE mode")
        
    elseif mode == "normal" then
        AntiExploit.Config.AUTO_BAN_THRESHOLD = 0.95
        AntiExploit.Config.AUTO_KICK_THRESHOLD = 0.90
        AntiExploit.Config.AUTO_WARN_THRESHOLD = 0.80
        
        print("[AntiExploit] Switched to NORMAL mode - Protection active")
        ply:ChatPrint("[AntiExploit] Switched to NORMAL mode")
        
    else
        local current = AntiExploit.Config.AUTO_BAN_THRESHOLD >= 1.0 and "SAFE" or "NORMAL"
        ply:ChatPrint("[AntiExploit] Current mode: " .. current)
        print("[AntiExploit] Thresholds - Warn: " .. (AntiExploit.Config.AUTO_WARN_THRESHOLD * 100) .. "% | Kick: " .. (AntiExploit.Config.AUTO_KICK_THRESHOLD * 100) .. "% | Ban: " .. (AntiExploit.Config.AUTO_BAN_THRESHOLD * 100) .. "%")
    end
end)

-- Status command
concommand.Add("antiexploit_status", function(ply, cmd, args)
    if not ply:IsAdmin() then return end
    
    print("\n=== ANTIEXPLOIT SYSTEM STATUS ===")
    
    -- Mode
    local mode = AntiExploit.Config.AUTO_BAN_THRESHOLD >= 1.0 and "SAFE MODE" or "NORMAL MODE"
    print("Mode: " .. mode)
    
    -- Thresholds
    print("\nThresholds:")
    print("- Warn: " .. (AntiExploit.Config.AUTO_WARN_THRESHOLD * 100) .. "%")
    print("- Kick: " .. (AntiExploit.Config.AUTO_KICK_THRESHOLD * 100) .. "%")
    print("- Ban: " .. (AntiExploit.Config.AUTO_BAN_THRESHOLD * 100) .. "%")
    
    -- AI Brain status
    if AntiExploit.AIBrain then
        print("\n[AI Brain]")
        print("Neural Network: " .. (AntiExploit.AIBrain.neural_network and "ACTIVE" or "INACTIVE"))
        print("Training Samples: " .. (AntiExploit.AIBrain.neural_network.training_samples or 0))
        print("Learning Rate: " .. (AntiExploit.AIBrain.neural_network.learning_rate or 0))
    end
    
    -- Threat Database
    if AntiExploit.ThreatDatabase then
        print("\n[Threat Database]")
        print("Network Signatures: " .. #(AntiExploit.ThreatDatabase.network_signatures or {}))
        print("Workshop Threats: " .. #(AntiExploit.ThreatDatabase.workshop_threats or {}))
        print("Malicious Domains: " .. #(AntiExploit.ThreatDatabase.malicious_domains or {}))
    end
    
    -- Player monitoring
    print("\n[Player Monitoring]")
    print("Tracked Players: " .. table.Count(AntiExploit.PlayerData or {}))
    print("Whitelist Admins: " .. tostring(AntiExploit.Config.WHITELIST_ADMINS))
    
    -- Performance
    print("\n[Performance]")
    print("Server FPS: " .. math.Round(1 / engine.TickInterval(), 1))
    print("Memory Usage: " .. math.Round(collectgarbage("count") / 1024, 1) .. " MB")
    
    print("\n================================")
    
    ply:ChatPrint("[AntiExploit] Status printed to console")
end)